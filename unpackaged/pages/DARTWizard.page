<apex:page id="ProductPicker" standardController="Opportunity" extensions="DARTWizardContExt" sidebar="false" showHeader="true"
    title="DARTForce ">
<script>
    
    var bExtraInputsMsg = false;
     
    function mycarousel_reloadCallback(carousel, state) {
    //alert("777");
};
    
    function mycarousel_itemLoadCallback(carousel, state)
{
    // Since we get all URLs in one file, we simply add all items
    // at once and set the size accordingly.
     return;
    if (state != 'init')
        return;

    
}
                    

function mycarousel_itemAddCallback(carousel, first, last, data)
{
    // Simply add all items at once and set the size accordingly.
    var items = data.split('|');

    for (i = 0; i < items.length; i++) {
        carousel.add(i+1, mycarousel_getItemHTML2(items[i]));
    }

    carousel.size(items.length);
}
                    
function mycarousel_getItemHTML2(url)
{
                    alert(url);
    return '<img src="' + url + '" width="80" height="75" alt="" />';
};
    
    function mycarousel_getItemHTML(record)
{
    //return '<img src="' + url + '" width="80" height="75" alt="" />';
    //alert("object: " + record);
    var content = "<div>";
    content += "<table cellpadding='0' cellspacing='0' class='style4' >";
    content += "<tr>";
    content += "<td>";
    content += "<table cellpadding='0' cellspacing='0' class='style1'>";
    content += "<tr>";
    content += "<td class='style6'>";
    
    content += "</td><td>";
    content += "<table cellpadding='0' cellspacing='0' class='style1'>";
    content += "<tr>";
    content += "<td style='font-size: 8px;font-weight: normal;'>";
    content += "<font style='font-size: 10px;font-weight: bold;'>" + record.Name + "</font>";
    content += "<br/>";
    content += "<apex:outputText >";
    content += "MSRP $ " + record.Product2.Standard_Price__c;
    content += "</apex:outputText>";
    content += "<br/>";
    content += "<apex:outputText >";
    content += "Price $ " + record.Product2.Minimum_Price__c;
    content += "</apex:outputText>";
    content += "<br/>";
    content += "Qty: <input type='text' name='qty[" + record.Id + "]' id='qty[" + record.Id + "]' value='' style='width:30px'  />";
    content += "<br/>";
    content += "<a href=\"javascript:void(0)\" onclick=\"addProductToList('" + record.Id + "');\" style='font-size: 9px;font-weight: bold;'>Add Device</a>";
    content += "</td>";
    content += "</tr>";
    content += "<tr>";
    content += "<td>";
    content += "</td>";
    content += "</tr>";
    content += "</table>";                                                  
    content += "</td>";
    content += "</tr>";
    content += "</table>";
    content += "</td>";
    content += "</tr>";
    content += "</table>";        
    content += "</div>";
    
    return content;
    
}
    function showMessageBox(message){
        Ext.Msg.show({
           title:'Alert',
           msg: message,
           buttons: Ext.Msg.OK,
           icon: Ext.MessageBox.INFO
        });
    }
    
    function addProductToList(productId){
        var strQty = document.getElementById("qty[" + productId + "]").value
        if(isNaN(strQty)){
            showMessageBox("Please enter the quantity requested.");
        }else{
            if(strQty == ''){
                strQty = '0';
            }
            var qty = parseInt(strQty)  
            if(qty == 0){
                showMessageBox("Quantity must be greater than zero");
            }else{
                selectProduct(productId, qty, false);
            }
        }   
    }
    
    function addUpgradeProductToList(productId){
        var strQty = document.getElementById("qty[" + productId + "]").value
        if(isNaN(strQty)){
            showMessageBox("Please enter the quantity requested.");
        }else{
            if(strQty == ''){
                strQty = '0';
            }
            var qty = parseInt(strQty)  
            if(qty == 0){
                showMessageBox("Quantity must be greater than zero");
            }else{
                selectProduct(productId, qty, true);
            }
        }   
    }
    
    function rateChange(){
    
        var selIndex = document.getElementById("ProductPicker:mainForm:RateLineBlock:ratePlanSelect").selectedIndex;
        var strRateText = document.getElementById("ProductPicker:mainForm:RateLineBlock:ratePlanSelect")[selIndex].text;
        alert(strRateText);
    
        //var a = "a"; //document.getElementById("ProductPicker:mainForm:RateLineBlock:theRatePercentField").style.display;
        //var b = document.getElementById("ProductPicker:mainForm:RateLineBlock:theRatePercent");
        //alert(a + '-' + b);
    
    }
    
    function validateRateInformation(){
    
        var strDevice = document.getElementById("ProductPicker:mainForm:RateLineBlock:rateDeviceSelect").value
        var strRate = document.getElementById("ProductPicker:mainForm:RateLineBlock:ratePlanSelect").value
        var selIndex = document.getElementById("ProductPicker:mainForm:RateLineBlock:ratePlanSelect").selectedIndex;
        var strRateText = document.getElementById("ProductPicker:mainForm:RateLineBlock:ratePlanSelect")[selIndex].text;
        var strLines = document.getElementById("ProductPicker:mainForm:RateLineBlock:theRateLines").value
        var strFeature = document.getElementById("ProductPicker:mainForm:RateLineBlock:rateFeaturePlanSelect").value
    
        if(strDevice == '0'){
            showMessageBox("Please select a device.");
            return;
        }
    
        if(strRate == '0'){
            showMessageBox("Please select a rate plan.");
            return;
        }
    
        if(isNaN(strLines)){
            showMessageBox("Please enter the number of lines requested.");
            return;
        }else{
            var qty = parseInt(strLines)  
            if((qty == 0) || (isNaN(qty))){
                showMessageBox("Lines must be greater than zero");
                return;
            }
        }
    
        if(strFeature == '0'){
            //showMessageBox("Please select feature(s).");
            //return;
        }
    
        var index=strRateText.indexOf("Pool");
        if(index != -1){
            showMessageBox("Pooling plan configuration is required for this rate plan.");
            document.getElementById("ProductPicker:mainForm:RateLineBlock:btnUsage").disabled = false;
            
        }
    
        var index=strRateText.indexOf("PMR");
        if(index != -1){
            showMessageBox("Verify Usage Assumptions.");
            document.getElementById("ProductPicker:mainForm:RateLineBlock:stepTwoPreviousButton2").disabled = false;
            
        }

        selectRate();
            
    }
    
        function openLookupPopup()
        {
            var flag = document.getElementById("ProductPicker:mainForm:theEnterpriseFlag").value;
            var oId = "{!opportunity.Id}";
            var url="/apex/DARTSmallBusinessPooling?id=" + oId; 
            if(flag == "false"){
                url="/apex/DARTPollingOptions?id=" + oId;
            }
    
            newWin=window.open(url, 'Popup','height=700,width=600,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');
            if (window.focus) 
            {
                newWin.focus();
            }
            
            //return false;
        }
    
        function openUsagePopup()
        {
            var oId = "{!opportunity.Id}";
            var url="/apex/DARTUsageAssumptions?id=" + oId;
            newWin=window.open(url, 'Popup','height=550,width=600,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');
            if (window.focus) 
            {
                newWin.focus();
            }
            
            //return false;
        }
    
        function openConfigureFeatures(deviceId){
            var deviceId = document.getElementById("ProductPicker:mainForm:RateLineBlock:rateDeviceSelect").value;
            var rateId = document.getElementById("ProductPicker:mainForm:RateLineBlock:ratePlanSelect").value;
            var lines = document.getElementById("ProductPicker:mainForm:RateLineBlock:theRateLines").value;
            var dId = deviceId.split("/");
            
            var url="/apex/DARTConfigureFeatures?deviceId=" + dId[0] + "&rateId=" + rateId + "&qty=" + lines;
            newWin=window.open(url, 'Popup','height=500,width=800,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');
            if (window.focus) 
            {
                newWin.focus();
            }
        }
    
    function openBBPopup()
        {
            var oId = "{!opportunity.Id}";
            var url="/apex/DARTBlackberryLicenses?id=" + oId;
            newWin=window.open(url, 'Popup','height=400,width=700,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');
            if (window.focus) 
            {
                newWin.focus();
            }
            
            //return false;
        }
        
        function closeLookupPopup()
        {
        if (null!=newWin)
        {
        newWin.close();
        }  
        }
        
        function addItem(){
            //alert('Done');
            var carousel = $('.jcarousel');
            carousel.jcarousel('reload');
    
        }
    
        function showDialog(){
            //$( "#dialog" ).dialog( "open" );
            //$( "#dialog-message" ).dialog( "open" );

            //document.getElementById("ProductPicker:mainForm:systemMessage").value = "xxxxx";
            //$( "#dialog-message" ).dialog( "open" );
            $( "#dialog-form" ).dialog( "open" );
        }
    
        function addComment(){
            //$( "#dialog-form" ).dialog( "open" );
        }
    
        function showSystemAlert(){
            try{
                var showAlert = document.getElementById("ProductPicker:mainForm:RateLineBlock:stepTwoPreviousButton2").disabled;
                if(!showAlert){
                    if(!bExtraInputsMsg){
                        bExtraInputsMsg = true;
                        showMessageBox("Polling plan configuration is required.");
                    }
                }
            }catch(err){}
        }
    
    function searchKeyPress(e)
    {
        // look for window.event in case event isn't passed in
       
    }
    
    function ConfirmDeleteOLD(rowId){
        //Ext.Msg.confirm("Confirm","Are you sure you want to delete this device?" + "<br />" + "Any associated rates plans will be deleted as well.", function(btn, text){
        Ext.Msg.confirm("Confirm","Are you sure you want to delete this device?", function(btn, text){
            if (btn == "yes"){
                removeProduct(rowId);
            }
        });
    }
        
    function ConfirmDelete(rowId, deviceName){
        //Ext.Msg.confirm("Confirm","Are you sure you want to delete this device?" + "<br />" + "Any associated rates plans will be deleted as well.", function(btn, text){
        return confirm("Are you sure you want to delete device " + deviceName + "?\n\n" + "Any associated rates plans will be deleted as well.");
    }
    
    function ConfirmFeatureDelete(rowId){
        Ext.Msg.confirm('Confirm', 'Are you sure you want to delete this feature?', function(btn, text){
            if (btn == 'yes'){
                removeFeature(rowId);
            }
        });
    }
    
    
    function ConfirmRateDelete(rowId){
        Ext.Msg.confirm('Confirm', 'Are you sure you want to delete this rate plan?', function(btn, text){
            if (btn == 'yes'){
                removeRate(rowId);
            }
        });
    }
    
    function showResult(btn){
        alert(btn);
    };
    
    function keypressed(rowId){
        if(event.keyCode=='13'){
            alert('you pressed enter: ' + rowId);
            addProductToList(rowId);
        }
    }
        
    function loading(val) {
    if (val) {
      document.getElementById('contentLoading').style.display = 'block';
    }
    else {
      document.getElementById('contentLoading').style.display = 'none';
    }
  }
        
    function rateLoading(val) {
    if (val) {
      document.getElementById('productLoading').style.display = 'block';
    }
    else {
      document.getElementById('productLoading').style.display = 'none';
    }
  }
        function accessoryLoading(val){
            if (val) {
              document.getElementById('accessoryLoading').style.display = 'block';
            }
            else {
              document.getElementById('accessoryLoading').style.display = 'none';
            }   
        }
    </script>
 
<!--  TODO: Before deploy change to use min files  -->
<!--<apex:includeScript value="{!URLFOR($Resource.ProductPickerJQuery, 'js/jquery-1.4.2.min.js')}"/>

<apex:includeScript value="{!URLFOR($Resource.ProductPickerJQuery, 'js/jquery-ui-1.8.2.custom.min.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.ProductPickerJQuery, 'js/jquery.effects.core.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.ProductPickerJQuery, 'js/jquery.effects.highlight.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.ProductPickerJQuery, 'js/jquery.escape-1.0.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.ProductPickerJQuery, 'js/jquery.blockUI.js')}"/>
<apex:includeScript value="{!URLFOR($Resource.ProductPickerJQuery, 'js/jquery.simpletip-1.3.1.min.js')}"/>


<apex:includeScript value="{!URLFOR($Resource.ProductPicker, 'js/bignumber.js')}"/>
<apex:includeScript value="{!$Resource.ProductPickerController}"/>-->
    <apex:stylesheet value="{!URLFOR($Resource.pikachoose, 'styles/bottom.css')}"/>
    <!--<apex:includeScript value="{!URLFOR($Resource.pikachoose, 'lib/jquery.pikachoose.js')}"/>-->
    <!--<apex:includeScript value="{!URLFOR($Resource.carousel, 'lib/jquery-1.4.2.min.js')}"/>-->
    
    <!--<apex:includeScript value="{!URLFOR($Resource.jquery17)}"/>
    <apex:includeScript value="{!URLFOR($Resource.carousel, 'lib/jquery.jcarousel.min.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.carousel, 'skins/tango/skin.css')}"/>-->
    
    <apex:includeScript value="{!URLFOR($Resource.jquery17)}"/>
    <apex:includeScript value="{!URLFOR($Resource.jcarouselJS)}"/>
    <apex:stylesheet value="{!URLFOR($Resource.carousel, 'skins/tango/skin.css')}"/>
    
    
    <apex:includeScript value="{!$Resource.extallJS}"/>
    <apex:includeScript value="{!$Resource.DragSelectorJS}"/>
    <apex:includeScript value="{!$Resource.LabelEditor}"/>
    <apex:stylesheet value="{!URLFOR($Resource.resources, 'css/ext-all.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.DragSelectorCSS)}"/>
    
    <apex:stylesheet value="{!URLFOR($Resource.chosen, 'chosen.css')}"/>
    
    <!--<apex:stylesheet value="{!URLFOR($Resource.slider, 'slider.css')}"/>-->
    
    <apex:stylesheet value="{!URLFOR($Resource.jqueryTheme, '/development-bundle/themes/ui-lightness/ui.theme.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.jqueryTheme, '/development-bundle/themes/ui-lightness/ui.base.css')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.bgiframe-2.1.2.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.ui.core.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.ui.widget.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.ui.mouse.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.ui.draggable.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.ui.position.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.ui.resizable.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.ui.dialog.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.effects.core.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.effects.blind.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.dialog, '/jquery.effects.explode.js')}"/>
    
    <apex:stylesheet value="{!URLFOR($Resource.multiselect, 'jquery.multiselect.css')}"/>
    <apex:includeScript value="{!URLFOR($Resource.multiselect, 'jquery.multiselect.js')}"/>
    
    <apex:includeScript value="{!URLFOR($Resource.select2, 'select2.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.select2, 'select2.css')}"/>

<!--  TODO: Move to   $Resource.ProductPicker -->
    
<style type="text/css">
        /* TODO shouldn't be necessary */
        .ui-button { margin-left: -1px; }
        .ui-button-icon-only .ui-button-text { padding: 0.35em; }
        .ui-autocomplete-input { margin: 0; padding: 0.48em 0 0.47em 0.45em; width:80%;}
        .family-input { width:150px;}
        .pricebook-select { width:auto; min-width: 150px;}
        .deletedRow {text-decoration: line-through; color:red;}
        .editingRow {font-style:italic; color:blue;}
        .impressionCell {width: 60px; text-align:center; }


        .bodyDiv, .sfdcBody{
            min-width: 1300px;
        }

        .bodyDiv, .sfdcBody , body { overflow: visible; }

        #headerPageBlock    { width: 65%; float: left; }
        #totalPageBlock { width: 35%%; float: right; }
        #summaryPageBlock { width: 0%; float: right; }
        #mainPageBlock    { width: 100%; float: left; }
        #opptyPageBlock    { width: 100%; float: left; }
    
         /*  #mainPageBlock    { width: 65%; float: left; } *\

        #productPickerTable, .searchTableClass{
            table-layout:fixed;
            verflow:hidden;
            border-collapse:separate;
            font-size:11px;
            width:100%;
            padding:2px;
        }

        #oliList {
            width: 100%;
            border-collapse: collapse;
        }


        #oliList tr.parentproduct td {

            padding:10px 0 0;
        }

        #oliList th {
            font-size:11px;
            padding: 5px 0px 5px;
            text-align: center;
            border-bottom: 1px solid #7094FF;
        }

        .productNameCell {
            text-align: left;
        }

        a.productEditBttn {
            visibility: hidden;
        }

        #oliList tr:hover a.productEditBttn {
            visibility: visible;
            cursor:pointer;
        }

        #oliList tr:hover { background-color: #FFFFFF; }

        .oliTable {
            width: 100%;
            text-align: center;
        }

        .oliTable-th {
            font-size:11px;
            padding: 5px 0px 5px;
            text-align: center;
            border-bottom: 1px solid #7094FF;
        }

        .oliTable-td {
            text-align: center;
        }

        .td-parentName {
            text-align: left;
        }

        div.package-component-name {
            font-style: italic;
            padding-left: 15px;
        }

        .td-childTotal {

        }

        /* We are making invisible the today link for date input fiels */
        .dateFormat {
            display:none;
        }

        .feedback {
            font-size:14px;
            left:75%;
            position:relative;
        }

        .updateSection {
            font-weight:bold;
            padding-top:15px;
            text-align:center;
        }

        .descriptionIcon:hover {
            background-position: right top;
        }
        .descriptionIcon {
            background-image: url('{!URLFOR($Resource.ProductPicker, 'images/helpOrbs.gif')}' ) ;
            background-position: left top;
            height: 15px;
            width: 20px;
        }

        .tooltip{
            background-color: #F5F5B5;
            border: 1px solid #DECA7E;
            color: #303030;
            font-family: sans-serif;
            font-size: 12px;
            line-height: 18px;
            padding: 10px 13px;
            position: absolute;
            text-align: center;
            z-index: 2;
            top:0;
            left:0;
        }

        .priceErrorMsg{
            color:red;
            display:none;
        }
    
        .visibleDiv, #topLeft, #topRight, #bottomLeft, #bottomRight
        {
            position: fixed;
            width: 255px;
            border: solid 1px #e1e1e1;
            vertical-align: middle;
            background: #1797C0;
            border:solid;
            border-color: black;
            border-width: 1px;
            -webkit-border-radius: 20px;-moz-border-radius: 20px;border-radius: 20px;
        }
    
            #topRight
        {
            top: 100px;
            right: 20px;
        }
    
    /**
     * Overwrite for having a carousel with dynamic width.
     */
    
    .jcarousel-skin-tango .jcarousel-container {
        background: #FFFFFF;
    }
    
    .jcarousel-skin-tango .jcarousel-container-horizontal {
        width: 90%;
    }
    
    .jcarousel-skin-tango .jcarousel-clip-horizontal {
        width: 1100px;
    }
    
</style>

<style>
      .activeTab {background-color: #236FBD; color:white; 
         background-image:none}
      .inactiveTab { background-color: lightgrey; color:black; 
         background-image:none}
   </style>

    <style type="text/css">
        .style1
        {
            width: 100%;
            border-width: 0px;
            font-family: Arial, Helvetica, sans-serif;
        }
        .style2
        {
            width: 190px;
        }
        .style3
        {
            width: 100%;
            border: 1px solid #FF0000;
        }
        .newStyle1
        {
            font-family: Arial, Helvetica, sans-serif;
            font-size: small;
        }
        .style4
        {
            width: 300px;
            height: 50px;
            border-width: 0px;
        }
        .style5
        {
            width: 32px;
            height: 32px;
            text-align: center;
        }
        .style6
        {
            width: 55px;
            text-align: center;
        }
        table.ex1
        {
        border-collapse:separate;
        border-spacing:10px;
        width: 50%;
        }
        table.ex2
        {
        border-collapse:separate;
        border-spacing:10px 50px;
        }
    </style>

<script type="text/javascript">

jQuery(document).ready(function() { 
     jQuery('#mycarousel').jcarousel({
         visible: 5,
        itemLoadCallback: mycarousel_itemLoadCallback,
        reloadCallback: mycarousel_reloadCallback
    });
    
    
});
    
    Ext.require([
        'Ext.window.MessageBox',
        'Ext.tip.*'
    ]);

</script>

<script type="text/javascript">
$(function(){

    $("#example").multiselect({
        selectedList: 4
    });
    
});
</script>

<script>
        $(document).ready(function() { $("#e1").select2(); });
    </script>

<apex:outputPanel id="messagePanel">
    <apex:pageMessages />
</apex:outputPanel>

<apex:form id="mainForm" rendered="{!showMainFrame}">
    <!--hidden field so AVD_Final__c can be accessed in controller-->
    <apex:outputText value="{!opportunity.AVD_Final__c}" rendered="false"/>
    <apex:actionFunction id="selectProduct" name="selectProduct" action="{!selectProduct}"
        rerender="rateDeviceSelect,OppLineRateBlock,OppLineFeatureBlock,messagePanel,theSelectedRatePanel,bottomMessagePanel" >
        <apex:param name="productParam" assignTo="{!selectedProductId}" value="" />
        <apex:param name="quantityParam" assignTo="{!selectedProductQty}" value="" />
        <apex:param name="upgradeParam" assignTo="{!selectedIsUpgrade}" value="" />
    </apex:actionFunction>
    
    <!--<apex:actionFunction id="removeProduct" name="removeProduct" action="{!removeProduct}" rerender="OppLineRateBlock,OppLineFeatureBlock,messagePanel,theButtonSection, theSelectedRatePanel,ratePlanSelect, rateDeviceSelect,theRatePercent, theRateLines, theRateCode, theRateComments, messagePanel,myStatus,theSelectedRateFeaturePanel,theList,rateFeaturePlanSelect,RateLineBlock,theSelectedRatePanel,messagePanel,myStatus,theSelectedRateFeaturePanel,theList,rateFeaturePlanSelect, theEnterpriseFlag" >-->
    <apex:actionFunction id="removeProduct" name="removeProduct" action="{!removeProduct}" rerender="rateDeviceSelect,OppLineRateBlock,OppLineFeatureBlock,messagePanel,theSelectedRatePanel,bottomMessagePanel" >
        <apex:param name="productParam" assignTo="{!selectedProductId}" value="" />
    </apex:actionFunction>
    
    <apex:actionFunction id="removeRate" name="removeRate" action="{!removeRate}" rerender="theSelectedRatePanel,messagePanel,bottomMessagePanel,myStatus,theSelectedRateFeaturePanel,theList,rateFeaturePlanSelect, theEnterpriseFlag,OppLineRateBlock" >
        <apex:param name="productParam" assignTo="{!selectedDeleteRate}" value="" />
    </apex:actionFunction>
    
    <apex:actionFunction id="removeNewFeature" name="removeProduct" action="{!removeProduct}" rerender="OppLineRateBlock,OppLineFeatureBlock,messagePanel,bottomMessagePanel" >
        <apex:param name="productParam" assignTo="{!selectedProductId}" value="" />
    </apex:actionFunction>
    
    <apex:actionFunction id="saveItems" name="saveItems" action="{!saveItems}" rerender="theButtonSection, theSelectedRatePanel,ratePlanSelect, rateDeviceSelect,theRatePercent, theRateLines, theRateCode, theRateComments, messagePanel,bottomMessagePanel,myStatus" >
    </apex:actionFunction>
    
    <apex:actionFunction id="selectRate" name="selectRate" action="{!selectRate}" rerender="theButtonSection, theSelectedRatePanel,ratePlanSelect, rateDeviceSelect,theRatePercent, theRateLines, theRateCode, theRateComments, messagePanel,myStatus,bottomMessagePanel,theSelectedRateFeaturePanel,theList,rateFeaturePlanSelect,theEnterpriseFlag,OppLineRateBlock" status="rateLoader" >
    </apex:actionFunction>
    <apex:actionStatus id="rateLoader" onstart="rateLoading(true)" onstop="rateLoading(false)" />
    
    <apex:actionFunction id="selectFeature" name="selectFeature" action="{!selectFeature}" rerender="theList" >
    </apex:actionFunction>
    
    <apex:actionfunction id="selectAccessory" name="selectAccessory" action="{!selectAccessory}" rerender="messagePanel, bottomMessagePanel,OppAccessoryBlock,theSelectedAccessoryPanel" status="accessoryLoader" >
    </apex:actionfunction>
    <apex:actionStatus id="accessoryLoader" onstart="accessoryLoading(true)" onstop="accessoryLoading(false)" />
    

    
    <div id="dialog" title="Basic dialog">
        <p></p>
    </div>

     <apex:outputpanel id="pricebook2IdPanel" rendered="false" >
     </apex:outputpanel>
     
     <apex:inputHidden value="{!enterpriseFlag}" id="theEnterpriseFlag"/>
     <table border="0" cellspacing="0" cellpadding="0" width="100%" cols="2">
        <tbody>
            <tr>
                <td width="65%">
                    <apex:pageBlock id="OppDetails" title=" Opportunity Details"  rendered="true"  >
                            <apex:pageblockbuttons location="top" >
                                <apex:commandbutton action="{!saveItems}" value="Save" id="saveButton" />
                                <apex:commandButton action="{!saveClose}" value="Save and Close"/>
                                <apex:commandButton action="{!save}" value="Submit"/>
                                <apex:commandbutton action="{!Cancel}" value="Cancel" id="cancelButton" />
                            </apex:pageblockbuttons>
                         <apex:pageBlockSection columns="2">
                                <apex:outputField value="{!opportunity.Name}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                                <apex:outputField value="{!opportunity.Engineering_Costs__c}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                                
                                <apex:outputField value="{!opportunity.Contract_Type__c}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                                <apex:outputField value="{!opportunity.AVD_Type__c}">
                                </apex:outputField>
                                
                                <apex:outputField value="{!opportunity.Contract_Term_Months__c}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                                <!--<apex:outputField value="{!opportunity.AVD_Discount_Picklist__c}">
                                    
                                </apex:outputField>-->
                                
                                <apex:outputField value="{!opportunity.Months_of_Deployment__c}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                                <apex:outputField value="{!opportunity.Business_Partner_Sale_or_Cosell_Deal__c}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                                
                                <apex:outputField value="{!opportunity.Type}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                         
                                <apex:outputField value="{!opportunity.Activation_or_Loyalty_Credit_Amount__c}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                                <apex:outputField value="{!opportunity.Waived_ETF_Percent__c}">
                                    <apex:inlineEditSupport showOnEdit="saveButton, cancelButton"  hideOnEdit="editButton" event="ondblclick"  changedStyleClass="myBoldClass" resetFunction="resetInlineEdit"/>
                                </apex:outputField>
                            </apex:pageBlockSection> 
                     </apex:pageBlock>
                </td>
                <td width="35%" valign="top">
                    
                    <apex:pageBlock id="totaldPanel" title="Deal Details" rendered="true">
                        <apex:pageblockbuttons location="top" >
                                <apex:commandbutton action="{!calculateDetails}" value="Refresh" rerender="totaldPanel,messagePanel,bottomMessagePanel" status="loading"/>
                            </apex:pageblockbuttons>
                            
                            
                            <table border="0" cellSpacing="10" cellPadding="10" width="100%" style="border-collapse:separate;border-spacing:10px;">
                                <tr>
                                <td width="30%"><apex:outputLabel value="Operating Margin:" /></td>
                                <td style="color:{!IF((opportunity.Operating_Margin__c > 0), 'green', 'red')};"><b><apex:outputfield value="{!opportunity.Operating_Margin__c}"></apex:outputfield></b></td>
                                </tr>
                                <tr>
                                <td width="30%"><apex:outputLabel value="Payback Months:" /></td>
                                <td><b><apex:outputfield value="{!opportunity.Payback_Months__c}"></apex:outputfield></b></td>
                                </tr>
                                <tr>
                                <td width="30%"><apex:outputLabel value="Market Invest/Line:"  /></td>
                                <td style="color:{!IF((opportunity.Market_Invest_per_Line__c > 0), 'green', 'red')};"><b><apex:outputfield value="{!opportunity.Market_Invest_per_Line__c}" ></apex:outputfield></b></td>
                                </tr>
                                <tr>
                                <td width="30%"><apex:outputLabel value="Approver:" /></td>
                                <td><b><apex:outputfield value="{!opportunity.Final_Approver__c}"></apex:outputfield></b></td>
                                </tr>
                            </table>

                               
                        </apex:pageBlock>
                        <apex:actionStatus id="loading" onstart="loading(true)" onstop="loading(false)" />
                            <div id="contentLoading" style="display:none;">
                            <div style="text-align: center;">
                              <img src="/img/loading.gif" alt="Loading graphic" /> Calculating Totals...
                            </div>
                          </div>
                    </td>
                    </tr>
                    </tbody>
                                        </table>
    
     <apex:pageBlock id="ProductBlock" title=" Step 1: Add Device">

     <table width="93%" border="0">
          <tr>
            <td>
                    <apex:outputText value="Please select a device from the list below:">
                    </apex:outputText>  
            </td>
            <td align="right" valign="middle">
                <div align="right">
                    Search&nbsp;<apex:inputText value="{!selectedSearchText}" id="theSearchInput" label=":" required="false"/>&nbsp;<input id="TotalsSave" type="image" src="{!URLFOR($Resource.search)}" alt="submit" value="Save" onclick="addItem();return false;"/>
                    &nbsp;
                    Brand: &nbsp;
                    <apex:selectList id="searchBrand" styleClass="family-input" size="1" value="{!selectedSearchBrand}" style="width:200px" >
                        <apex:selectOptions id="searchBrandOptions" value="{!searchBrand}" />
                        <apex:actionSupport event="onchange" 
                            action="{!UpdateSearchItems}"
                            rerender="searchBrand">
                        </apex:actionSupport>
                     </apex:selectList>  
                    &nbsp;
                    <apex:outputLabel value="Device Type:" for="searchType"/>&nbsp;
                    <apex:selectList id="searchType" styleClass="family-input" size="1" value="{!selectedSearchType}" style="width:200px">
                        <apex:selectOptions id="searchTypeOptions" value="{!searchType}" />
                        <apex:actionSupport event="onchange" 
                            action="{!UpdateSearchItems}"
                            rerender="searchType">
                        </apex:actionSupport>
                     </apex:selectList>  &nbsp;
                     <input id="TotalsSave" type="image" src="{!URLFOR($Resource.refresh)}" alt="submit" value="Save" onclick="addItem();return false;"/>
                </div>
            </td>
          </tr>
        </table>
    <br/> 
        <apex:outputPanel id="searchProducts">
        <ul id="mycarousel" class="jcarousel-skin-tango">
            <apex:repeat value="{!Products}" var="product" id="theRepeat">
            <li >
                    <div>
                            <table cellpadding="0" cellspacing="0" class="style4" >
                                <tr>
                                    <td>
                                        <table cellpadding="0" cellspacing="0" class="style1">
                                            <tr>
                                                <td class="style6">
                                                    <apex:variable var="imageVar" value="{!product.Product2.Image__c}"/>
													<!--<apex:variable var="imageVar" value="genericPhone.jpg"/>-->
                                                    <apex:image url="{!URLFOR($Resource.phoneImages, imageVar)}" width="64" height="64"/>
                                                    </td>
                                                <td>
                                                    <table cellpadding="0" cellspacing="0" class="style1">
                                                        <tr>
                                                            <td style="font-size: 8px;font-weight: normal;">
                                                               <font style="font-size: 10px;font-weight: bold;">{!product.name}</font>
                                                                <br/>
                                                                    <apex:outputText value="{0, number, 0.00}">
                                                                       MSRP $<apex:param value="{!product.Product2.Standard_Price__c}" />
                                                                    </apex:outputText>
                                                                <br/>
                                                                    <apex:repeat value="{!PriceField}" var="field">
                                                                            Price $<apex:outputtext value="{!product.Product2[field]}"> </apex:outputtext>   
                                                                        </apex:repeat>
                                                                    <!--<apex:outputText value="{0, number, 0.00}">
                                                                       Price $<apex:param value="{!product.Product2.Minimum_Price__c}" />
                                                                    </apex:outputText>-->
                                                                <br/>
                                                                    Qty: <input type="text" name="qty[{!product.Id}]" id="qty[{!product.Id}]" value="" style="width:30px"  />
                                                                <br/>
                                                                    <apex:outputpanel rendered="{!showNewDevices}"><a href="javascript:void(0)" onclick="addProductToList('{!product.Id}');" style="font-size: 9px;font-weight: bold;">Add New Device</a><br/></apex:outputpanel>
                                                                    <apex:outputpanel rendered="{!showUpgrades}"><a href="javascript:void(0)" onclick="addUpgradeProductToList('{!product.Id}');" style="font-size: 9px;font-weight: bold;">Add Upgrade</a></apex:outputpanel>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>        
                        </div>
            </li>
            </apex:repeat>
        </ul>
        </apex:outputPanel>
    <br/>
          <table width="93%" border="0">
          <tr>
            <td valign="middle">
                Items Found:&nbsp;<apex:outputText value="{!searchCount}" id="theSearchCount" />
            </td>
            <td valign="middle">
                <div align="right">
                    
                </div>
            </td>
          </tr>
        </table>

     </apex:pageBlock>
     
    <div id = "mainPageBlock" >
     
      <apex:pageBlock id="OppLineRateBlock" title=" Step 2: Selected Device(s)"  rendered="true"  >
      <apex:outputText value="Please review your selected device(s).">
      </apex:outputText>
      <br/> <br/><br/>
      <div  id="tableDetails" >
    
                            <table id="productPickerTable" >
                                <col width="10%"></col>
                                <col width="20%"></col>
                                <col width="10%"></col>
                                <col width="10%"></col>
                                <col width="10%"></col>
                                <col width="10%"></col>
                                <col width="5%"></col>
                                <col width="15%"></col>
                                <col width="10%"></col>
                                <tr>
                                    <th colspan="4">
                                     
                                    </th>
                                </tr>
                                <tr align='center'>
                                    <th><center></center></th>
                                    <th><center>Device</center></th>
                                    <th><center>MSRP</center></th>
                                    <th><center>Rep Price</center></th>
                                    <th><center>Customer Price</center></th>
                                    <th><center>Quantity</center></th>
                                    <th><center><apex:outputtext rendered="{!showUpgrades}">Upgrade</apex:outputtext></center></th>
                                    <th><center>Notes</center></th>
                                    <th><center></center></th>
                                </tr>
                                <apex:repeat id="deviceLineItemRowModelRepeat"  value="{!selectedProducts}" var="deviceRow">
                                <tr class="{!deviceRow.lineitem.id} parentproduct">
                                    <td>
                                        <!--<apex:image url="{!URLFOR($Resource.phoneImages, 'bb_bold.jpg')}" width="64" height="64"/>-->
										<apex:variable var="imageVar" value="{!deviceRow.lineItem.Product2.Image__c}"/>
                                        <apex:image url="{!URLFOR($Resource.phoneImages, imageVar)}" width="64" height="64"/>
                                    </td>
                                    <td> 
                                      <!--<apex:outputText value="{!deviceRow.lineItem.Name}"  />x
                                      <a href="http://www.hyperlinkcode.com" >{!deviceRow.lineItem.Name}</a>-->
                                        <!--<apex:outputText value="{!deviceRow.productName}"  />-->
                                        <apex:outputText value="{!deviceRow.productName}"  />
                                        <!--<br/><apex:outputText value="{!deviceRow.lineItem.Name}"  />-->
                                    </td>
                                     <td>
                                        <center>$
                                            <!--<apex:outputText value="{!deviceRow.opptyLineItem.Standard_Price__c}"  />-->
                                            <apex:outputText value="{0, number, 00.00}">
                                                <apex:param value="{!deviceRow.opptyLineItem.Standard_Price__c}" />
                                            </apex:outputText>
                                        </center>
                                    </td>
                                    <td>
                                        <center>$
                                            <!--<apex:outputText value="{!deviceRow.opptyLineItem.UnitPrice}"  />-->
                                            <apex:outputText value="{0, number, 00.00}">
                                                <apex:param value="{!deviceRow.opptyLineItem.Rep_Price__c}" />
                                            </apex:outputText>
                                        </center>
                                    </td>
                                    <td>
                                        <!--<center><apex:inputText value="{!deviceRow.lineItem.Product2.Minimum_Price__c}" style="width:75px" /></center>-->
                                       <center>
                                             <!--<apex:outputText rendered="{!IF(CONTAINS(deviceRow.productName, 'BPS Device'), false, true)}">-->
                                             <apex:inputfield required="true" value="{!deviceRow.opptyLineItem.UnitPrice}"  style="width:75px" rendered="{!AND(NOT(deviceRow.opptyLineItem.Is_Promo_Code__c),NOT(deviceRow.selected))}" />
                                             <apex:outputtext value="{!deviceRow.opptyLineItem.UnitPrice}" rendered="{!AND(NOT(deviceRow.opptyLineItem.Is_Promo_Code__c),deviceRow.selected)}"  style="width:75px"  />
                                             <!--</apex:outputText>-->
                                             <apex:outputtext value="{!deviceRow.opptyLineItem.UnitPrice}" rendered="{!deviceRow.opptyLineItem.Is_Promo_Code__c}" style="width:75px"  />
                                      </center>
                                       
                                    </td>
                                     <td>
                                         <!--<apex:inputText value="{!deviceRow.quantity}" />-->
                                         <center><apex:inputfield value="{!deviceRow.opptyLineItem.Quantity}" style="width:45px"   /></center>
                                    </td>
                                    <td>
                                         <center><apex:inputcheckbox disabled="true" value="{!deviceRow.opptyLineItem.IsUpgrade__c}"   rendered="{!showUpgrades}"/></center>
                                    </td>
                                     <td class="oliTable-td" >
                                          <center><apex:inputTextArea value="{!deviceRow.opptyLineItem.Description}" cols="35" rows="2" /></center>
                                        <!--<apex:commandLink id="noteButton"
                                            action="{!deleteProduct}"
                                            oncomplete="deleteProduct( '{!$Component.oliRowId}' );">
                                          <apex:image url="{!URLFOR($Resource.notepad)}" alt="Delete" title="Click to add Notes." />
                                          <apex:param name="rowToDeleteParam" value="{!deviceRow.index}" assignTo="{!rowToDelete}"/>
                                        </apex:commandLink>-->
                                    </td>
                                    <td class="oliTable-td" style="padding-left: 10px">
                                        <apex:commandLink id="delDeviceButton"   onclick="return ConfirmDelete('{!deviceRow.index}','{!deviceRow.opptyLineItem.PricebookEntry.name}');" action="{!removeProduct}">
                                          <apex:image url="{!URLFOR($Resource.deleteIcon)}" alt="Delete" title="Click to delete Device {!deviceRow.opptyLineItem.PricebookEntry.name}" />
                                          <apex:param name="rowToDeleteParam" value="{!deviceRow.index}" assignTo="{!selectedProductId}"/>
                                        </apex:commandLink>
                                        <!--<input id="TotalsSave" type="image" src="{!URLFOR($Resource.deleteIcon)}" alt="submit" value="Save" onclick="ConfirmDelete('{!deviceRow.index}');return false;" title="Click here to delete the selected device."/>-->
                                    </td>
                                </tr>
                                </apex:repeat>
                              </table>
                    <!--</apex:pageBlock>-->
                    <br/><br/><br/>
                    
                </div>
            
    
    
      
         </apex:pageBlock>
         
    <apex:pageBlock id="RateLineBlock"  title="Step 3: Select Rate Plan(s)">
        <apex:pageblockbuttons location="bottom" >
            <apex:commandButton action="{!saveItems}" value="Save"/>
            <apex:commandButton action="{!saveClose}" value="Save and Close"/>
            <apex:commandButton action="{!save}" value="Submit"/>
            <apex:commandButton action="{!Cancel}" value="Cancel"/>
        </apex:pageblockbuttons>
                        
        <table width="93%" border="0">
          <tr>
            <td>
                    <apex:outputText value="Please specify your device(s) Rate Plan.">
                    </apex:outputText>
            </td>
            <td>
                <apex:outputPanel id="theButtonSection">
                <div align="right">
                    <apex:commandButton onclick="javascript:openLookupPopup(); return false" value="Pooling Plans" id="stepTwoPreviousButton2"  disabled="{!showInputs}"/>
                    <apex:commandButton value="Usage Assumptions" id="btnUsage" onclick="javascript:openUsagePopup(); return false"   rerender="messagePanel,bottomMessagePanel" rendered="true"  disabled="false"/>
                    <apex:commandButton value="Licenses" id="stepTwoNextButton"  onclick="javascript:openBBPopup(); return false" rerender="messagePanel,bottomMessagePanel" disabled="false" />
                </div>
                </apex:outputPanel>
            </td>
          </tr>
        </table>
        
        <br/><br/>
        <!--<apex:pageBlockSection columns="1">
            <apex:inputText value="{!numberLines}" id="theTextInput" label="Quantity:" required="true" size="6"/>
            <apex:inputTextarea id="newDesc" cols="90" value="{!comments}" label="Notes:"/>
        </apex:pageBlockSection>-->
        
        <b></b>
        <br/>
        <table id="productPickerTable" style="width:100%">
            <col width="15%"></col>
            <col width="15%"></col>
            <col width="5%"></col>
            <col width="5%"></col>
            <col width="5%"></col>
            <col width="20%"></col>
            <col width="15%"></col>
            <tr>
                <th colspan="4">
                </th>
            </tr>
            <tr align='center'>
                <th><center>Device</center></th>
                <th><center>Rate Plan</center></th>
                <th><center>%</center></th>
                <th><center>Lines</center></th>
                <th><center>SOC Code</center></th>
                <th><center>Features</center></th>
                <th><center>Comments</center></th>
            </tr>
            <tr>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <div id="productLoading" style="display:none;">
                    <div style="text-align: center;">
                      <img src="/img/loading.gif" alt="Loading graphic" /> Adding Product...<br/><br/><br/>
                    </div>
                  </div>
            </tr>
            <tr>
                <td valign="top">
                  <center><apex:selectlist id="rateDeviceSelect" styleClass="family-input" size="1" value="{!selectedRateDevice}" style="width:200px"  >
                    <apex:selectOptions id="productFamily22" value="{!rateDevices}" />
                  </apex:selectlist></center>
                </td>
                <td valign="top">
                  <center><apex:selectList id="ratePlanSelect" styleClass="family-input" size="1" value="{!selectedRatePlan}" style="width:235px" >
                    <apex:selectOptions id="productFamily" value="{!ratePlans}" />
                    <apex:actionsupport event="onchange"
                        action="{!updateRateLineProperties}"
                        rerender="theRateCode,theRatePercent, messagePanel,bottomMessagePanel,rateFeaturePlanSelect">
                    </apex:actionsupport>
                  </apex:selectList></center>
                </td>
                <td valign="top">
                    <center>
                        <!--<apex:outputText value="{!selectedRatePercent}" id="theRatePercent" ></apex:outputText>-->
                        <apex:inputtext value="{!selectedRatePercent}" id="theRatePercent" disabled="{!selectedRateFlag}"  maxlength="4" style="width:35px;" />
                    </center>
                </td>
                <td valign="top">
                    <center><apex:inputtext value="{!selectedRateLines}" id="theRateLines" size="3"  maxlength="4" /></center>
                </td>
                 <td valign="top">
                    <center>
                            <!-- <apex:outputText value="{!selectedRateCode}" id="theRateCode"  />-->
                            <apex:inputtext value="{!selectedRateCode}" id="theRateCode" disabled="{!selectedRateFlag}" style="width:75px;" />
                        </center>
                    </td>
                <td style="width:200px" valign="top">
                
                    <center>
                        <table id="rateFeaturePickerTable" style="width:250px">
                                    <tr>
                                        <td width="225px">
                                                <apex:selectlist id="rateFeaturePlanSelect" styleClass="family-input" size="1" value="{!selectedFeaturePlan}" style="width:325px"  disabled="{!featureFlag}">
                                                    <apex:selectOptions id="featureList" value="{!featurePlans}" />
                                                  </apex:selectlist>
                                        </td>
                                        <td  valign="middle" width="50px" style="padding-left:5px;">
                                            <center><!--<input id="TotalsSave" type="image" src="{!URLFOR($Resource.add)}" alt="submit" value="Save" />-->
                                                <apex:commandlink action="{!addNewFeature}" id="theCommandLink" rerender="theList" >
                                                    <apex:image url="{!URLFOR($Resource.add)}" alt="Delete" title="Click to add the selected feature" />
                                                </apex:commandlink>
                                            </center>
                                        </td>
                                    </tr>
                        </table>
                        
                    </center>
                    <apex:dataList value="{!selectedFeaturesList}" var="featureItem" id="theList">
                        <table width="375px">
                            <tr>
                                <td width="325px"><apex:outputText value="{!featureItem.featureName}"/></td>
                                <td width="50px">
                                    <!--<input id="TotalsSave" type="image" src="{!URLFOR($Resource.add)}" alt="submit" value="Save" />-->
                                        <apex:commandlink action="{!removeNewFeature}"  rerender="theList"  value="remove">
                                            <apex:param name="deleteParm" value="{!featureItem.featureId}" assignTo="{!selectedDeleteFeature}"/>
                                        </apex:commandlink>
                                    </td>
                            </tr>
                        </table>
                    </apex:dataList>
                </td>
                <td valign="top">
                    <center>
                        <center><apex:inputtextarea id="theRateComments" value="{!selectedRateComments}" cols="35" rows="2" /></center>
                    </center>
                </td>
            </tr>
          </table>
           <br/>
           <center><table class="searchTableClass">
             <tr>
                <th></th>
                <th>Add Rate Plan</th>
            </tr>
            <tr>
                <td>
                </td>
                <td >
                   <apex:image url="{!URLFOR($Resource.ProductPicker, 'images/arrow_down.png')}" alt="Select"
                         onclick="validateRateInformation();" style="cursor:pointer" title="Click to add the above Rate" />
                   
                </td>
            </tr>
          </table>
          </center>
                    <!--</apex:pageBlock>-->
                    <br/><br/>
                    
                    <!--<apex:pageBlock title="Selected Rate Plans">-->
                    <apex:outputpanel id="theSelectedRatePanel" style="width:100%">
                        <table  id="oliList" width="100%" cellpadding="25" cellspacing="10">
                            <colgroup>
                                <col width="15%"></col>
                                <col width="15%"></col>
                                <col width="5%"></col>
                                <col width="5%"></col>
                                <col width="5%"></col>
                                <col width="25%"></col>
                                <col width="10%"></col>
                                <!--<apex:outputPanel rendered="{!isChannelSteering}">-->
                                    <col width="15%"></col>
                                <!--</apex:outputPanel>-->
                                <col width="5%"></col>
                            </colgroup>
                             <tr>
                                <th><center>Device</center></th>         
                                <th><center>Rate Plan</center></th>
                                <th><center>%</center></th>
                                <th><center>Lines</center></th>
                                <th><center>SOC Code</center></th>
                                <th><center>Features</center></th>
                                <th><center>Comments</center></th>
                                <!--<apex:outputPanel rendered="{!isChannelSteering}">-->
                                    <th><center>Rate Plan Price</center></th>
                                <!--</apex:outputPanel>-->
                                <th><center></center></th>
                            </tr>
                            <tr>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                            <apex:repeat id="rateLineItemRowModelRepeat"  value="{!selectedRates}" var="rateRow">
                            <tr>
                                <td valign="top">  
                                    <center>
                                        <!--<apex:selectList id="rateDeviceSelect" styleClass="family-input" size="1" value="{!rateRow.productId}" style="width:200px" >
                                            <apex:selectOptions id="productFamily22" value="{!rateDevices}" />
                                        </apex:selectList>-->
                                        <apex:outputText value="{!rateRow.device}" id="theRateDevice" style="width:200px;"    />
                                    </center>
                                </td>
                                
                                <td valign="top">  
                                    <center>
                                        <!--<apex:selectList id="ratePlanSelect" styleClass="family-input" size="1" value="{!rateRow.planId}" style="width:275px" >
                                            <apex:selectOptions id="productFamilyA" value="{!ratePlans}" />
                                        </apex:selectList>-->
                                        <apex:outputText value="{!rateRow.plan}" id="theRatePlan" style="width:235px;"    />
                                    </center>
                                </td>
                                
                                <td valign="top">    
                                    <center><apex:outputText value="{!rateRow.opptyLineItem.Percent__c}" id="theRatePercentAA" style="width:25px;"    /></center>
                                </td>
                                
                                <td valign="top">
                                     <center><apex:inputField value="{!rateRow.opptyLineItem.Quantity}" id="theRateLinesA"  style="width:50px;" /></center>
                                </td>
                                
                                 <td valign="top" style="padding-left:10px;">
                                     <center><apex:outputText value="{!rateRow.opptyLineItem.SOC_Code__c}" id="theRateCodeAA"  /></center>
                                </td>
                                
                                <td style="padding-bottom:25px;padding-left:10px;" valign="top">
                                    <center>
                                        <table id="selectedRateFeaturePickerTable" style="width:225px">
                                                    <tr>
                                                        <td width="175px">
                                                                <apex:selectList id="selectedRateFeaturePlanSelect" styleClass="family-input" size="1" value="{!selectedFeatureAddOn}" style="width:325px" >
                                                                    <apex:selectOptions id="featureList" value="{!featurePlans}" />
                                                                  </apex:selectList>
                                                        </td>
                                                        <td  valign="middle" width="50px" style="padding-left:5px;">
                                                            <center><!--<input id="TotalsSave" type="image" src="{!URLFOR($Resource.add)}" alt="submit" value="Save" />-->
                                                                <apex:commandlink action="{!addNewFeatureItem}" id="theCommandLink" rerender="theSelectRateFeatureList" >
                                                                    <apex:image url="{!URLFOR($Resource.add)}" alt="Add" title="Click to add the selected feature" />
                                                                    <apex:param name="rateParam" assignTo="{!selectedRateAddOn}" value="{!rateRow.rateProductId}" />
                                                                </apex:commandlink>
                                                            </center>
                                                        </td>
                                                    </tr>
                                        </table>
                                        
                                    </center>
                                    <br/>
                                    <apex:dataList value="{!rateRow.rateFeatures}" var="featureItem" id="theSelectRateFeatureList">
                                        <table width="225px">
                                            <tr>
                                                <td width="175px">
                                                    <apex:outputText value="{!featureItem.featureName}"/>
                                                    <br/>
                                                    <apex:outputPanel rendered="{!isChannelSteering}">
                                                        Feature Price:&nbsp;&nbsp;<apex:inputField value="{!featureItem.opptyLineItem.UnitPrice}" style="width:75px;" />
                                                    </apex:outputPanel>
                                                </td>
                                                
                                                <td width="50px">
                                                    <!--<input id="TotalsSave" type="image" src="{!URLFOR($Resource.add)}" alt="submit" value="Save" />-->
                                                        <apex:commandlink action="{!removeNewFeatureItem}"  rerender="theSelectRateFeatureList"  value="remove">
                                                            <apex:param name="deleteParm" value="{!featureItem.featureName}" assignTo="{!selectedDeleteFeatureAddOn}"/>
                                                            <apex:param name="rateParam" assignTo="{!selectedRateAddOn}" value="{!rateRow.rateProductId}" />
                                                        </apex:commandlink>
                                                    </td>
                                            </tr>
                                        </table>
                                        <hr/>
                                    </apex:dataList>
                                    
                                </td>
                                     
                                <td valign="top" style="padding-left:10px;">
                                    <center>
                                        <center><apex:inputTextArea value="{!rateRow.opptyLineItem.Description}" cols="35" rows="2" /></center>
                                    </center>
                                </td>
                                
                                <!--<apex:outputPanel rendered="{!isChannelSteering}">-->
                                <td valign="top">
                                    <center>
                                        <center>
                                            <apex:inputText value="{!rateRow.opptyLineItem.UnitPrice}" style="width:100px" />
                                            <!--<apex:inputText value="{!rateRow.opptyLineItem.UnitPrice}" style="width:100px"  rendered="{!isChannelSteering}" />
                                            <apex:outputtext value="{!rateRow.opptyLineItem.UnitPrice}" rendered="{!NOT(isChannelSteering)}" style="width:75px"  />-->
                                        </center>
                                    </center>
                                </td>
                                <!--</apex:outputPanel>-->
                                
                                <td class="oliTable-td"  valign="top">
                                    <!--<center><apex:commandLink id="delButton"
                                        action="{!removeProduct}"
                                        rerender="OppLineRateBlock,messagePanel" >
                                      <apex:image url="{!URLFOR($Resource.deleteIcon)}" alt="Delete" title="Click to delete Rate {!rateRow.plan}" />
                                      <apex:param name="rowToDeleteParam" value="{!rateRow.index}" assignTo="{!selectedProductId}"/>
                                    </apex:commandLink></center>-->
                                    
                                    <input id="TotalsSave" type="image" src="{!URLFOR($Resource.deleteIcon)}" alt="submit" value="Save" onclick="ConfirmRateDelete('{!rateRow.index}');return false;" title="Click here to delete the selected rate."/>
                                </td>
                            </tr>
                            </apex:repeat>
                        </table>
                        </apex:outputpanel>
                        
                        <br/>
          <table width="93%" border="0">
          <tr>
            <td><!--<div align="center">
                <apex:outputText style="font-weight:bold;color:red;" value="NOTICE:"/><br/>
                Your current plan requires additional configuration.
                </div>-->
            </td>
            <td>
                
            </td>
          </tr>
        </table>
        <br/>
    </apex:pageBlock>
                  
     <apex:pageBlock id="OppAccessoryBlock" title=" Step 4: Accessories"  >
         
        <apex:outputText value="Please enter device accessories.">
        </apex:outputText>
        <br/> <br/>
        
        <div  id="tableDetails" >
          
        <!--<apex:pageBlockSection columns="1">
            <apex:selectList id="chooseColor" value="{!accessoriesSold}" size="1" label="Accessories Sold:">
                <apex:selectOption itemValue="No" itemLabel="No"/>
                <apex:selectOption itemValue="Yes" itemLabel="Yes"/>
        </apex:selectList> 
            <apex:inputText value="{!accessoryDiscount}" id="theTextInput" label="Accessory Discount %:" maxlength="4" size="5"/>
        
        <br/>
        </apex:pageBlockSection>-->
        
        <center>
        <table id="productPickerTable" width="50%">
                <col width="33%"></col>
                <col width="33%"></col>
                <col width="33%"></col>
                <tr>
                    <th colspan="4">
                    </th>
                </tr>
                <tr align='center'>
                    <th><center>Description</center></th>
                    <th><center>Sugg. Retail Price (SRP)</center></th>
                    <th><center>Units</center></th>
                </tr>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <div id="accessoryLoading" style="display:none;">
                        <div style="text-align: center;">
                          <img src="/img/loading.gif" alt="Loading graphic" /> Adding Accessory...<br/><br/><br/>
                        </div>
                      </div>
                </tr>
                <tr>
                    <td>
                        <center>
                            <apex:inputText value="{!selectedAccDesc}" id="theAccessoryDesc" style="width:200px" />
                        </center>
                    </td>
                 
                    <td>
                        <center>
                            <apex:inputText value="{!selectedAccSRP}" id="theAccessoryPrice" style="width:100px" />
                        </center>
                    </td>
                    <td>
                        <center>
                            <apex:inputText value="{!selectedAccUnits}" id="theAccessoryLines" size="6" disabled="false"/>  
                        </center>
                    </td>
                     
                </tr>
        </table>
        </center>
        <br/>
        <center>
        <table class="searchTableClass">
                 <tr>
                    <th></th>
                    <th>Add Accessory</th>
                </tr>
                <tr>
                    <td>
                    </td>
                    <td >
                       <apex:image url="{!URLFOR($Resource.ProductPicker, 'images/arrow_down.png')}" alt="Select"
                             onclick="selectAccessory();" style="cursor:pointer" title="Click to add the above Accessory" />
                    </td>
                </tr>
        </table>
        </center>
        <br/><br/>
    
        <apex:outputPanel id="theSelectedAccessoryPanel">
            
        <center>
            <apex:datatable value="{!selectedAccessories}" var="row" styleClass="ex1" border="0">   
                <apex:column width="33%">
                    <apex:facet name="header"><center>Description</center></apex:facet>
                    <center><apex:inputfield value="{!row.Description}" id="theAccessoryDesc" style="width:200px" /></center>
                </apex:column>      
                <apex:column width="33%">
                    <apex:facet name="header"><center>Sugg. Retail Price (SRP)</center></apex:facet>
                    <center><apex:inputfield value="{!row.UnitPrice}" style="width:100px" /></center>
                </apex:column>
                <apex:column width="33%">
                    <apex:facet name="header"><center>Units</center></apex:facet>
                    <center><apex:inputfield value="{!row.Quantity}" style="width:75px"/></center>
                </apex:column>
                <apex:column >
                    <input id="TotalsSave" type="image" src="{!URLFOR($Resource.deleteIcon)}" alt="submit" value="Save"  title="Click here to delete the selected accessory."/>
                </apex:column>
            </apex:datatable>
        </center>
            
            <!--<table id="selectedAccessoryTable" width="70%">
                 <colgroup>
                    <col width="33%"></col>
                    <col width="33%"></col>
                    <col width="33%"></col>
                </colgroup>
                    <tr align='center'>
                        <th><center>Description</center></th>
                        <th><center>Sugg. Retail Price (SRP)</center></th>
                        <th><center>Units</center></th>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                    <apex:dataList value="{!selectedProducts}" var="accessoryItem" id="theAccessoryList">
                        <tr>
                            <td>
                                <center>
                                    <apex:inputtext value="{!accessoryItem.productName}" id="theSelectedAccessoryDesc" />
                                </center>
                            </td>
                         
                            <td>
                                <center>
                                    <apex:inputtext value="{!accessoryItem.productName}" id="theSelectedAccessoryPrice" />
                                </center>
                            </td>
                            <td>
                                <center>
                                    <apex:inputtext value="{!accessoryItem.productName}" id="theSelectedAccessoryQty" />
                                </center>
                            </td>
                             
                        </tr>
                    </apex:dataList>
            </table>-->
        </apex:outputPanel>
        
      </div>
     <br/>
          
        <br/>
        </apex:pageBlock>
        
    <apex:outputPanel id="bottomMessagePanel">
        <apex:pageMessages />
    </apex:outputPanel>
    
</div>

    <apex:inputField value="{!opportunity.AVD_Discount__c}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Contract_Type__c}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Contract_Term_Months__c}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Months_of_Deployment__c}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Type}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Tenure__c}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Tenure_Modification__c}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Is_Promo_Code__c}" rendered="false"></apex:inputField>
    <apex:inputField value="{!opportunity.Promo_Code__c}" rendered="false"></apex:inputField>
    
</apex:form>

</apex:page>